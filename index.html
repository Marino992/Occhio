<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio Anatomico: L'Occhio Umano</title>
    <style>
        body { margin: 0; background: #050505; font-family: 'Segoe UI', sans-serif; color: white; overflow-x: hidden; }
        #header { text-align: center; padding: 30px 20px; background: #111; border-bottom: 2px solid #007bff; }
        h1 { margin: 0; color: #007bff; text-transform: uppercase; letter-spacing: 2px; font-size: 1.8rem; }
        .eye-emoji { font-size: 4rem; display: block; margin: 10px 0; animation: blink 4s infinite; }
        @keyframes blink { 0%, 90%, 100% { opacity: 1; } 95% { opacity: 0.3; } }
        
        #main-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
        
        /* Contenitore Canvas */
        #canvas-container { position: relative; width: 100%; height: 500px; touch-action: none; background: radial-gradient(circle, #151515 0%, #050505 100%); }
        #ui { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 8px; z-index: 10; border: 1px solid #444; }
        
        #info-card { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 85%; max-width: 400px; background: rgba(20, 20, 20, 0.98); color: white; 
            padding: 20px; border-radius: 15px; border: 2px solid #007bff; 
            display: none; text-align: center; z-index: 100; box-shadow: 0 0 30px rgba(0,123,255,0.5);
        }
        
        button { cursor: pointer; padding: 12px 18px; background: #007bff; color: white; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
        button:hover { background: #0056b3; }
        
        /* Quiz Section */
        #quiz-section { width: 90%; max-width: 700px; margin: 50px auto; padding: 25px; background: #111; border-radius: 20px; border: 1px solid #333; }
        .quiz-q { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #222; }
        .quiz-q p { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
        .quiz-options { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { background: #222; text-align: left; padding: 12px; border: 1px solid #444; color: #ccc; cursor: pointer; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .opt-btn:hover { background: #333; border-color: #007bff; }
        .correct { background: #28a745 !important; color: white; border-color: #1e7e34 !important; }
        .wrong { background: #dc3545 !important; color: white; border-color: #bd2130 !important; }
        #quiz-result { text-align: center; font-size: 1.2rem; font-weight: bold; color: #007bff; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="header">
        <span class="eye-emoji">üëÅÔ∏è</span>
        <h1>L'Anatomia dell'Occhio 3D</h1>
        <p>Esplora l'interno e sfida i tuoi amici nel quiz!</p>
    </div>

    <div id="main-container">
        <div id="canvas-container">
            <div id="ui">
                <button onclick="window.toggleSclera()">ESPLORA INTERNO</button>
            </div>
            <div id="info-card">
                <h2 id="part-title" style="margin-top:0; color:#007bff;">Parte</h2>
                <p id="part-text">Descrizione...</p>
                <button onclick="this.parentElement.style.display='none'" style="margin-top: 10px; background:#444;">Chiudi</button>
            </div>
        </div>

        <div id="quiz-section">
            <h2 style="color: #007bff; text-align: center; font-size: 2rem;">Super Quiz dell'Occhio üß†</h2>
            <p style="text-align: center; color: #888; margin-bottom: 30px;">Rispondi alle 10 domande per diventare un esperto!</p>
            
            <div id="quiz-container"></div>
            <div id="quiz-result"></div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const descrizioni = {
            "Sclera": "La parte bianca protettiva che d√† forma all'occhio.",
            "Cornea": "La lente frontale trasparente che protegge l'iride.",
            "Iride": "La parte colorata che regola la luce restringendo la pupilla.",
            "Pupilla": "Il buco nero centrale che permette alla luce di entrare.",
            "Retina": "Il sensore che riceve le immagini e le invia al cervello.",
            "Macula": "Il centro della retina dove vediamo i dettagli pi√π piccoli.",
            "Nervo Ottico": "Il collegamento che trasmette i segnali visivi al cervello.",
            "Cristallino": "La lente interna che mette a fuoco gli oggetti vicini."
        };

        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        camera.position.set(0, 0, 3.8);
        controls.enableDamping = true;
        controls.dampingFactor = 0.07;

        const lightA = new THREE.AmbientLight(0xffffff, 1.2); scene.add(lightA);
        const lightP = new THREE.PointLight(0xffffff, 2); lightP.position.set(5, 5, 5); scene.add(lightP);

        const eyeGroup = new THREE.Group();
        scene.add(eyeGroup);

        // Modelli 3D
        const sclera = new THREE.Mesh(new THREE.SphereGeometry(1, 64, 64), new THREE.MeshPhongMaterial({ color: 0xffffff, shininess: 50 }));
        sclera.name = "Sclera"; eyeGroup.add(sclera);

        const iris = new THREE.Mesh(new THREE.RingGeometry(0.12, 0.52, 64), new THREE.MeshStandardMaterial({ color: 0x2a77cc, side: THREE.DoubleSide }));
        iris.position.z = 1.01; iris.name = "Iride"; eyeGroup.add(iris);

        const pupil = new THREE.Mesh(new THREE.CircleGeometry(0.12, 32), new THREE.MeshBasicMaterial({ color: 0x000000 }));
        pupil.position.z = 1.02; pupil.name = "Pupilla"; eyeGroup.add(pupil);

        const cristallino = new THREE.Mesh(new THREE.SphereGeometry(0.35, 32, 32), new THREE.MeshPhongMaterial({ color: 0xadd8e6, transparent: true, opacity: 0.6 }));
        cristallino.scale.set(1, 1, 0.4); cristallino.position.z = 0.6; cristallino.name = "Cristallino"; eyeGroup.add(cristallino);

        const retina = new THREE.Mesh(new THREE.SphereGeometry(0.98, 64, 64), new THREE.MeshPhongMaterial({ color: 0xffa07a, side: THREE.BackSide }));
        retina.name = "Retina"; eyeGroup.add(retina);

        const macula = new THREE.Mesh(new THREE.CircleGeometry(0.12, 32), new THREE.MeshBasicMaterial({ color: 0x8b4513, side: THREE.DoubleSide }));
        macula.position.set(-0.25, 0.1, -0.88); macula.lookAt(0,0,0);
        macula.name = "Macula"; macula.visible = false; eyeGroup.add(macula);

        const nerve = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.8, 32), new THREE.MeshPhongMaterial({ color: 0xffddbb }));
        nerve.position.z = -1.2; nerve.rotation.x = Math.PI / 2;
        nerve.name = "Nervo Ottico"; eyeGroup.add(nerve);

        // Interazione Raycast
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let mouseDownTime = 0;

        container.addEventListener('pointerdown', () => mouseDownTime = Date.now());
        container.addEventListener('pointerup', (e) => {
            if (Date.now() - mouseDownTime < 250) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(eyeGroup.children);
                const hit = intersects.find(i => i.object.visible && descrizioni[i.object.name]);
                if (hit) {
                    document.getElementById('part-title').innerText = hit.object.name;
                    document.getElementById('part-text').innerText = descrizioni[hit.object.name];
                    document.getElementById('info-card').style.display = 'block';
                }
            }
        });

        window.toggleSclera = () => {
            sclera.visible = !sclera.visible;
            macula.visible = !sclera.visible;
            retina.material.side = sclera.visible ? THREE.BackSide : THREE.DoubleSide;
        };

        function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
        animate();

        // QUIZ LOGIC
        const domande = [
            { q: "Qual √® la parte colorata dell'occhio?", a: ["Iride", "Sclera", "Retina"], c: 0 },
            { q: "Come si chiama la parte bianca?", a: ["Cornea", "Sclera", "Macula"], c: 1 },
            { q: "Dove vengono proiettate le immagini?", a: ["Sul Cristallino", "Sulla Retina", "Sull'Iride"], c: 1 },
            { q: "A cosa serve il Nervo Ottico?", a: ["A muovere l'occhio", "A pulire l'occhio", "A portare i dati al cervello"], c: 2 },
            { q: "Qual √® il buco da cui entra la luce?", a: ["Pupilla", "Macula", "Nervo"], c: 0 },
            { q: "Il cristallino serve a...", a: ["Proteggere", "Mettere a fuoco", "Colorare"], c: 1 },
            { q: "La Macula si occupa della visione...", a: ["Notturna", "Laterale", "Centrale e nitida"], c: 2 },
            { q: "La membrana trasparente davanti all'occhio √® la...", a: ["Cornea", "Retina", "Sclera"], c: 0 },
            { q: "Quante 'lenti' principali ha l'occhio?", a: ["Una", "Due (Cornea e Cristallino)", "Nessuna"], c: 1 },
            { q: "Dove si trova la Macula?", a: ["Dietro l'Iride", "Al centro della Retina", "Sopra la Sclera"], c: 1 }
        ];

        let punteggio = 0;
        const quizBox = document.getElementById('quiz-container');

        domande.forEach((d, idx) => {
            const div = document.createElement('div');
            div.className = 'quiz-q';
            div.innerHTML = `<p>${idx + 1}. ${d.q}</p><div class="quiz-options"></div>`;
            const opts = div.querySelector('.quiz-options');
            d.a.forEach((opt, oIdx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                btn.onclick = () => {
                    if (btn.parentElement.classList.contains('answered')) return;
                    btn.parentElement.classList.add('answered');
                    if (oIdx === d.c) {
                        btn.classList.add('correct');
                        punteggio++;
                    } else {
                        btn.classList.add('wrong');
                    }
                    if(document.querySelectorAll('.answered').length === 10) {
                        document.getElementById('quiz-result').innerText = `Fine! Punteggio: ${punteggio} su 10! üèÜ`;
                    }
                };
                opts.appendChild(btn);
            });
            quizBox.appendChild(div);
        });
    </script>
</body>
</html>
